---
layout: post
title: Milestone 1
---

## NHL Goaltenders from 2017-2018 season

We tried to explore goaltenders and consider who was the best goaltender of the 2016-2017 season as described by our data analysis below.

### What issues do you notice by using this metric to rank goalies? 

* issue 1: one goalie has 400 saves out of 500 shots, another has 4 saves out of 5 shots. They have the same "SV%", but are they equally good? 

In the former case, we have more information and data points to deduce the true ability of the goalie.  In the latter case, there are many uncertainties: we simply do not have enough data to conclude how good the player actually is.

* issue 2: while 400 saves out of 500 shots should be more impressive than 4 saves out of 5 shots, is that more impressive than 80 saves out of 100 shots? 

In fact, the “SV%” metric ignores the strengths of the teams. 

Goalies in the more dominating teams receive less shots, thanks to better defence players, and better pressure created by the forwards against the other teams ("The best defence is attack"). Even if two goalies' SV% are similar, the "general difficulty" they faced could be very different.

<div class="message">
 For example, in season 2017, Casey DeSmith (whose team ranked 2nd in its division) appeared 700:09 minutes, and had a SV% of 92.1%; Laurent Brossoit (whose team ranked 6th in its division) appeared 740:14 minutes, and had a SV% of 88.3%. The SV%'s are similar, but Casey DeSmith allowed 2.40 goals per 60 minutes on average, while Laurent Brossoit allowed 3.24 goals per 60 minutes. The overall team performances are vastly different.
 </div>

### What could be done to deal with this?

* in response to issue 1, I propose multiplying the ‘SV%’ by a scaling term  `log(1+GP)`, where `GP` is games played.

When GP is small, the scaling term is small; when GP is larger, it grows rapidly; after a certain point, the scaling term peaks. 

In the end, we want to make 4 saves out of 5 shots **less impressive** than 400 saves out of 500 shots, while 80 saves out of 100 shots should be about **as impressive** as 400 saves out of 500 shots.

* in response to issue 2: we can divide the ‘%SV’ by `GAA`, or 'Goals allowed average’ to “normalize” performance. 

As discussed, goalies in the weaker team have to work with weaker defence players and weaker forwards. Saving goals is more difficult for them and we want to reflect that. 

In the end, we want to make 90% save percentage in a weak team **more impressive** than 90% saving percentage in a strong team.

**Summary**: `new feature` = `SV% * log(1+GP) * GAA`


### Goalies sorted by save percentage ('SV%')

### Plot
<img src="/assets/images/q1.jpg" alt="">

<!-- Filter out the goalies using your proposed approach above, and produce a bar plot with player names on the y-axis and save percentage (‘SV%’) on the x-axis. You can keep the top 20 goalies. Ensure all of the axes are labeled and the title is appropriate. -->

### Conclusion

Discuss what other features could potentially be useful in determining a goalie’s performance.

* issue 3: the SV% did not take into account the **specific difficulty** against each individual shot. An empty net shot or a rebound shot is much more difficult to defend against. A goalie is less likely to be blamed for losing against a penalty shot. Also, a shot with a shorter shot distance is more dangerous. Therefore, the shot quality should be considered.

* feature 3: we can create a feature called "shot danger" to indicate the threat of shot depending on the type and distance of the shot. An empty net has shot danger 100%. A rebound shot may have 80%. The shorter distance the shot, the higher threat it has. The shot distance will be calculated from the coordinate of the shot.



## Data acquisition of NHL play-by-play data from season 2016-2017 to 2020-2021

Sanity check: [Game ID 2016020001](https://statsapi.web.nhl.com/api/v1/game/2016020001/feed/live/)

<!-- 
The first 4 digits identify the season of the game (ie. 2017 for the 2017-2018 season). The next 2 digits give the type of game, where 01 = preseason, 02 = regular season, 03 = playoffs, 04 = all-star. The final 4 digits identify the specific game number. For regular season and preseason games, this ranges from 0001 to the number of games played. (1271 for seasons with 31 teams (2017 and onwards) and 1230 for seasons with 30 teams). For playoff games, the 2nd digit of the specific number gives the round of the playoffs, the 3rd digit specifies the matchup, and the 4th digit specifies the game (out of 7).

download 2016-2020 regular season 02 & playoffs 03 
2016020001-
2017020001-2017021271
...
202002-->

### Tutorial

<!-- Write a brief tutorial on how your team downloaded the dataset. Imagine :) that you were searching for a guide on how to download the play-by-play data; your guide should make you go “Perfect - this is exactly what I was looking for!”. This can be as simple as copying in your function and an example usage, and writing one or two sentences describing it. -->

### Interactive Debugging Tool

Use: [ipywidgets](https://ipywidgets.readthedocs.io/en/latest/) with `IntSlider` while specifying function arguments and show it via matplotlib.

Able to specify season (year,regular or playoffs) and flip through all events for every game.

Draw event coordinates on an ice rink figure.

Description of the tool:

Sanity check: [Game ID 2017020001](https://www.nhl.com/gamecenter/tor-vs-wpg/2017/10/04/2017020001/recap/plays#game=2017020001,game_state=final,lock_state=final,game_tab=plays)

### Answer
![image](/assets/images/q3.jpg)

The widget displays the visulization of a play event on the rink, and also displays the relevant game information. We can choose any play event in any game, whether it is a regular season game or a playoff game.


## Tidy Data
## Question
[Useful](https://statsapi.web.nhl.com/api/v1/playTypes)

* Create a function to convert all events of every game into a pandas dataframe
* include events of the type “shots” and “goals”
* include as features (at minimum): game time/period information, game ID, team information (which team took the shot), indicator if its a shot or a goal, the on-ice coordinates, the shooter and goalie name (don’t worry about assists for now), shot type, if it was on an empty net, and whether or not a goal was at even strength, shorthanded, or on the power play.

1. include a small snippet of your final dataframe (e.g. using head(10)) screenshot.
2. You’ll notice that the “strength” field (i.e. even, power play, short handed) only exists for goals, not shots.(shot strength extrapolate players on ice within shot time) Furthermore, it doesn’t include the actual strength of players on the ice (i.e. 5 on 4, or 5 on 3, etc). Discuss how you could add the actual strength information (i.e. 5 on 4, etc.) (actually strength by relative ratio of players) to both shots and goals, given the other event types (beyond just shots and goals) and features available. You don’t need to implement this for this milestone.

### Answer:

we will include a state variable `strength` representing the strength of the team (should be 5 at the beginning). In the all plays data, there is a play type named 'Penalty' that represents a penalty event. It also documents which player will serve the penalty, the `datetime` or `periodTime` that this penalty happens, and the penalty time the player will serve. We can include this type of events in addition to shots and goals. When there is a penalty against one team, the `strength` variable of the team will be subtracted by one, and it will be updated in the next event. It returns to normal when the `periodTime` of next event is larger than the `periodTime` of the penalty + `penaltyMinutes`. For example, if the penalty event's `periodTime` is "00:38", and the penalty time is 2 minutes, then if the next event is a `shot`, and the `periodTime` is "01:38", we know the penalty is still there,  the strength is 4 against 5, and the shot is `shorthanded`. If another shot took place at "02:50", which is *later* than `periodTime` + `penaltyMinutes` (e.g. 2 min), then the `strength` should be updated back to 5, the shot is `even`. A `strength ratio` variable can also be calculated for every event *after* we update the `strength` of both teams.


4. In a few sentences, discuss some additional features you could consider creating from the data available in this dataset. We’re not looking for any particular answers, but if you need some inspiration, could a shot or goal be classified as a rebound, or a shot off the rush?

#### Answer

We can look for "rebound" by looking at the `dateTime` of a `shot`. A looser definition could be that, a second shot is a shot from rebound if two shots are placed within 10 seconds. A narrower and more realistic definition is when two shots are taken within 2-8 seconds, because if the two shots are taken within 1 second, it might be successive quick shots aimed at pushing the pluck across. If a second shot takes longer than 8 seconds, we might assume that the defence player has returned to normal positions. In that case, the second shot is more likely to be a slightly more organized attempt than a quick, chaotic and opportunistic scoring attempt, and we consider the latter to be a more proper 'rebound'.

## Simple Visualizations



## Advanced Visualizations

{% include advanced_vis.html %}
### Discuss (in a few sentences) what you can interpret from these plots.


### Consider the Colorado Avalanche; take a look at their shot map during the 2016-17 season. Discuss what you could say about the team during this season. Now look at the shot map for the Colorado Avalanche for the 2020-21 season, and discuss what you could conclude from these differences. Does this make sense? Hint: look at the standings.

2016:
<img src="/assets/images/colorado_avalanche_2016.png" alt="">

The shot frequency from Colorado is less or equal to league average on almost every position.


2020:
<img src="/assets/images/colorado_avalanche_2020.png" alt="">

The shot frequency from Colorado is higher than league average on most of the areas, especially on the left side.

The team ranking confirms our impression: Colorado was ranked last in their division in 2016, with 22 win out of 82 games; they ranked first in 2020-2021 season, winning 39 out of 56 games.


### Discuss what observations you can make. Is there anything that could explain the Lightning’s success, or the Sabres’ struggles? How complete of a picture do you think this paints?

2018:
<img src="/assets/images/tampa_2018.png" alt="">
<img src="/assets/images/buffalo_2018.png" alt="">
Tampa Bay has far more shots than league average in the center area, especially at the 60-80 feet area where threat of shots is highest. Sabres on the otherhand has less shots than league average, except at some peripheral areas. This suggests that Lightning’s is more successful at organizing attacks, and only place shots when it has a relatively high scoring chance (i.e. close to the net). In contrast, Sabres seems not able to shoot in close range where the threat would be the highest. Their above average shooting in the peripheral area suggests that they are forced to released shots in unfavorable places.

<img src="/assets/images/tampa_2019.png" alt="">
<img src="/assets/images/buffalo_2019.png" alt="">
Lightning’s has made significant improvement over season 2018: their average shots is higher than league average almost everywhere. They also have far more shots in the 80-90 feet area compared to 2018, which was their weakest area. The Sabres' maintains the same kind of performance, struggling to get shots in the 70-90 feet area that is right in front of the net, meaning their shots are most likely to be lower quality shots.


<img src="/assets/images/tampa_2020.png" alt="">
<img src="/assets/images/buffalo_2020.png" alt="">
If we look at the the y-axis, the excess shots vs Avg is significantly higher for Lightning’s compared to previous season. They continue to dominate most of the area, meaning that not only do they have more shots, most of the shots were placed right in front of the net as well. The Sabres’ shots however, has a similar to pattern to the previous years.

**Conclusion** Lightning’s has a shot pattern that excels in quality (the area of the shot) and in quantity (the overwhelming red area), and they have improved every season (the y-axis has to be adjusted). Sabres has lower quantity of shots (the blue area) and in particular, the shot quality is very low (the dark blue area in front of the net). They failed to improve in the three seasons.